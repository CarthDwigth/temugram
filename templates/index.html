<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>üì∏ TemuGram</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='estilos.css') }}">
</head>
<body>

<nav class="navbar">
    <strong>üì∏ TemuGram</strong>
    <div class="nav-links">
        {% if session.get('username') %}
            <span style="margin-right: 15px;">Hola, <b>@{{ session['username'] }}</b></span>
            <a href="{{ url_for('post_routes.crear_post') }}" class="link-publicar">Publicar</a>
            <a href="{{ url_for('auth_routes.logout') }}" class="link-salir">Salir</a>
        {% else %}
            <a href="{{ url_for('auth_routes.login') }}" class="link-login">Login</a>
            <a href="{{ url_for('auth_routes.registro') }}" class="link-registro">Registro</a>
        {% endif %}
    </div>
</nav>

<div class="main-layout">
    
    <main class="feed-column">
    {% if posts %}
        {% for p in posts %}
        <div class="post">
            
            <div class="post-header">
                <span>{{ p[5] or 'üë§' }}</span>
                <strong>@{{ p[0] }}</strong>
            </div>

            <a href="{{ url_for('main_routes.ver_post', post_id=p[3]) }}">
                <img src="{{ p[2] }}" class="post-img" alt="Foto">
            </a>

            <div class="post-content-area">
                
                <div class="post-acciones">
                    <button onclick="darLike('{{ p[3] }}')" id="btn-like-{{ p[3] }}" class="btn-like-clean">
                        ‚ù§Ô∏è <span id="like-count-{{ p[3] }}">{{ p[6] or 0 }}</span>
                    </button>
                </div>

                <div class="post-info">
                    <strong>@{{ p[0] }}</strong> <span>{{ p[1] }}</span>
                </div>

                <div class="comentarios-seccion">
                    <div class="lista-comentarios">
                        {% set lista = comentarios_dic.get(p[3]) %}
                        {% if lista %}
                            {% for c in lista %}
                                <div class="comentario-item">
                                    <p class="comentario-texto">
                                        <strong>@{{ c.username }}:</strong> {{ c.texto }}
                                    </p>
                                    <div class="comentario-stats">
                                        <form action="{{ url_for('post_routes.reaccionar_comentario', comentario_id=c.id) }}" method="POST" style="margin: 0;">
                                            <button type="submit" class="btn-like-mini">ü§ç</button>
                                        </form>
                                        <span class="comentario-likes-count">{{ c.likes_count or 0 }}</span>
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <p style="color: grey; font-size: 0.8rem;">Sin comentarios a√∫n...</p>
                        {% endif %}
                    </div>
                    
                    <form action="{{ url_for('post_routes.comentar', post_id=p[3]) }}" method="POST" style="display: flex; gap: 8px; margin-top: 10px; align-items: center;">
                        <input type="text" name="texto" placeholder="A√±adir comentario..." required 
                            style="flex-grow: 1; background: #2c2c2c; border: 1px solid #444; color: white; border-radius: 20px; padding: 8px 15px; font-size: 0.9rem;">
                        <button type="submit" class="btn-comentar-estetico">Comentar</button>
                    </form>
                </div>

            </div> </div> {% endfor %}
    {% else %}
        <p style="text-align: center;">A√∫n no hay publicaciones.</p>
    {% endif %}

    </main>

    <aside class="sidebar-column">
    <div class="comunidad-card">
        <h3>üë• Comunidad</h3> 
        <div class="usuarios-lista">
            {% for u in usuarios %}
            <a href="{{ url_for('main_routes.perfil', username=u[1]) }}" class="usuario-item">
                <span class="usuario-emoji">{{ u[3] or 'üë§' }}</span>
                
                <div class="usuario-info">
                    <span class="usuario-nombre">@{{ u[1] }}</span>
                    <small class="usuario-fecha">Miembro desde: {{ u[4].strftime('%d/%m/%Y') if u[4] else 'Reciente' }}</small>
                </div>
            </a>
            {% endfor %}
        </div>
    </div>
</aside>

</div> 
<script>
function darLike(postId) {
    // Usamos /reaccionar/ que es la ruta que configuramos en Python
    fetch(`/reaccionar/${postId}`, { 
        method: 'POST',
        headers: { 
            'X-Requested-With': 'XMLHttpRequest', // Esto es vital para que Flask sepa que es AJAX
            'Content-Type': 'application/json' 
        }
    })
    .then(response => response.json())
    .then(data => {
        const likeSpan = document.getElementById(`like-count-${postId}`);
        const btn = document.getElementById(`btn-like-${postId}`);
        
        if (data.status === 'success') {
            // Usamos .total porque as√≠ lo manda tu Python
            likeSpan.innerText = data.total; 
            
            // Efecto visual: Rojo si dio like, Blanco si lo quit√≥
            if (data.accion === 'added') {
                btn.style.color = '#ff4d4d';
            } else {
                btn.style.color = '#fff';
            }
        }
    })
    .catch(error => console.error('Error:', error));
}
</script>
</script>
</script>
</body>
</html>
