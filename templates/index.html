<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>TemuGram</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #fafafa; margin: 0; }
        .navbar { 
            background: white; border-bottom: 1px solid #dbdbdb; 
            padding: 10px 20px; display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0; z-index: 100;
        }
        .nav-links a { margin-left: 15px; text-decoration: none; color: #0095f6; font-weight: bold; }
        .container { max-width: 500px; margin: 20px auto; }
        .post { background: white; border: 1px solid #dbdbdb; margin-bottom: 30px; }
        .post-header { padding: 10px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .btn-borrar { color: #ed4956; text-decoration: none; font-size: 0.8em; border: 1px solid #ed4956; padding: 2px 8px; border-radius: 3px; }
        .btn-borrar:hover { background-color: #ed4956; color: white; }
    </style>
</head>
<body>

    <nav class="navbar">
        <div class="logo"><strong>üì∏ TemuGram</strong></div>
        <div class="nav-links">
            {% if session.get('username') %}
                <span>Hola, @{{ session['username'] }}</span>
                <a href="/publicar">Publicar</a>
                <a href="/logout" style="color: #999;">Salir</a>
            {% else %}
                <a href="/login">Iniciar Sesi√≥n</a>
                <a href="/registro">Crear Cuenta</a>
            {% endif %}
        </div>
    </nav>

    <div class="container">
        {% for p in posts %}
        <div class="post">
            <div class="post-header">
                <span>üë§ @{{ p[0] }}</span>
                {% if session.get('username') == p[0] %}
                    <a href="{{ url_for('borrar_post', post_id=p[3]) }}" class="btn-borrar">Eliminar</a>
                {% endif %}
            </div>
            
            <img src="{{ p[2] }}" style="width:100%; display: block; min-height: 200px; background-color: #eee;" 
                 onerror="this.onerror=null;this.src='https://via.placeholder.com/500x500?text=Error+en+Link+de+Nube'">
            
            <div style="padding: 10px;">
                <strong>@{{ p[0] }}</strong> {{ p[1] }}
                
                <br>
                <button onclick="toggleComentarios('coments-{{ p[3] }}')" style="background:none; border:none; color:#8e8e8e; cursor:pointer; font-size:0.9em; padding:5px 0 0 0;">
                    Ver comentarios
                </button>
                <div style="padding: 10px; display: flex; gap: 10px; flex-wrap: wrap;">
                    {% set me_gusta = reacciones | selectattr('0', 'equalto', p[3]) | selectattr('1', 'equalto', 'Me gusta') | list | length %}
                    {% set no_gusta = reacciones | selectattr('0', 'equalto', p[3]) | selectattr('1', 'equalto', 'No me gusta') | list | length %}
                    {% set loca = reacciones | selectattr('0', 'equalto', p[3]) | selectattr('1', 'equalto', 'Eso es pa las Loca') | list | length %}

                    <a href="/reaccionar/{{ p[3] }}/Me gusta" style="text-decoration:none;">üëç ({{ me_gusta }})</a>
                    <a href="/reaccionar/{{ p[3] }}/No me gusta" style="text-decoration:none;">üëé ({{ no_gusta }})</a>
                    <a href="/reaccionar/{{ p[3] }}/Eso es pa las Loca" style="text-decoration:none;">üíÖ Eso es pa las Loca ({{ loca }})</a>
</div>

                <div id="coments-{{ p[3] }}" style="display: none; margin-top: 10px; border-top: 1px solid #eee; padding-top: 5px;">
                    {% for c in comentarios %}
                        {% if c[0] == p[3] %}
                            <p style="margin: 3px 0; font-size: 0.9em;">
                                <strong>@{{ c[1] }}</strong> {{ c[2] }}
                            </p>
                        {% endif %}
                    {% endfor %}

                    {% if session.get('username') %}
                    <form action="/comentar/{{ p[3] }}" method="POST" style="display:flex; margin-top:10px;">
                        <input type="text" name="texto" placeholder="A√±ade un comentario..." required style="flex-grow:1; border:1px solid #dbdbdb; padding:5px; border-radius:3px;">
                        <button type="submit" style="color:#0095f6; background:none; border:none; font-weight:bold; cursor:pointer; margin-left: 5px;">Publicar</button>
                    </form>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <script>
    function toggleComentarios(id) {
        var x = document.getElementById(id);
        x.style.display = (x.style.display === "none") ? "block" : "none";
    }
    </script>

</body>
</html>