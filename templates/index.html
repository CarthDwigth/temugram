<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>üì∏ TemuGram</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='estilos.css') }}">
</head>
<body>

<nav class="navbar">
    <strong>üì∏ TemuGram</strong>
    <div class="nav-links">
        {% if session.get('username') %}
            <span style="margin-right: 15px;">Hola, <b>@{{ session['username'] }}</b></span>
            <a href="{{ url_for('post_routes.crear_post') }}" class="link-publicar">Publicar</a>
            <a href="{{ url_for('auth_routes.logout') }}" class="link-salir">Salir</a>
        {% else %}
            <a href="{{ url_for('auth_routes.login') }}" class="link-login">Login</a>
            <a href="{{ url_for('auth_routes.registro') }}" class="link-registro">Registro</a>
        {% endif %}
    </div>
</nav>

<div class="main-layout">
    
    <main class="feed-column">
    {% if posts %}
        {% for p in posts %}
        <div class="post">
            
            <div class="post-header">
                <span>{{ p[5] or 'üë§' }}</span>
                <strong>@{{ p[0] }}</strong>
            </div>

            <a href="{{ url_for('main_routes.ver_post', post_id=p[3]) }}">
                <img src="{{ p[2] }}" class="post-img" alt="Foto">
            </a>

            <div class="post-content-area">
                
                <div class="post-acciones">
                    <button class="btn-like-clean"
                            data-post-id="{{ p[3] }}"
                            id="btn-like-{{ p[3] }}">
                        ‚ù§Ô∏è <span id="like-count-{{ p[3] }}">{{ p[6] or 0 }}</span>
                    </button>
                </div>

                <div class="post-info">
                    <strong>@{{ p[0] }}</strong> <span>{{ p[1] }}</span>
                </div>

                <div class="comentarios-seccion">
                    <div class="lista-comentarios">
                        {% set lista = comentarios_dic.get(p[3]) %}
                        {% if lista %}
                            {% for c in lista|reverse %}
                                <div class="comentario-item">
                                    <p class="comentario-texto">
                                        <strong>@{{ c.username }}:</strong> {{ c.texto }}
                                    </p>
                                    <div class="comentario-stats">
                                        <form action="{{ url_for('post_routes.reaccionar_comentario', comentario_id=c.id) }}" method="POST" style="margin: 0;">
                                            <button type="submit" class="btn-like-mini">ü§ç</button>
                                        </form>
                                        <span class="comentario-likes-count">{{ c.likes_count or 0 }}</span>
                                        {% if session.get('user_id') == c.user_id %}
                                            <button class="btn-borrar-comentario" data-id="{{ c.id }}" style="margin-left: 10px; color:red;">üóëÔ∏è</button>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <p style="color: grey; font-size: 0.8rem;">Sin comentarios a√∫n...</p>
                        {% endif %}
                    </div>
                    
                    <!-- Formulario para comentar, solo 1 por post -->
                    <form class="form-comentario" data-post-id="{{ p[3] }}" 
                        style="display: flex; gap: 8px; margin-top: 10px; align-items: center;">
                        <input type="text" name="texto" placeholder="A√±adir comentario..." required
                            style="flex: 1; background: #222; border: 1px solid #444; color: white; padding: 10px; border-radius: 20px; font-size: 0.9rem;">
                        <button type="submit" class="btn-comentar-estetico">Comentar</button>
                    </form>

                </div> <!-- comentarios-seccion -->

            </div> <!-- post-content-area -->
        </div> <!-- post -->
        {% endfor %}
    {% else %}
        <p style="text-align: center;">A√∫n no hay publicaciones.</p>
    {% endif %}

    </main>

    <aside class="sidebar-column">
    <div class="comunidad-card">
        <h3>üë• Comunidad</h3> 
        <div class="usuarios-lista">
            {% for u in usuarios %}
            <a href="{{ url_for('main_routes.perfil', username=u[1]) }}" class="usuario-item">
                <span class="usuario-emoji">{{ u[3] or 'üë§' }}</span>
                
                <div class="usuario-info">
                    <span class="usuario-nombre">@{{ u[1] }}</span>
                    <small class="usuario-fecha">Miembro desde: {{ u[4].strftime('%d/%m/%Y') if u[4] else 'Reciente' }}</small>
                </div>
            </a>
            {% endfor %}
        </div>
    </div>
</aside>

</div> 
<script>
// ------------------- Likes de posts -------------------
document.addEventListener('click', function(e){
    if(e.target.closest('.btn-like-clean')) {
        e.preventDefault();
        const btn = e.target.closest('.btn-like-clean');
        const postId = btn.dataset.postId;
        const countSpan = btn.querySelector('span');

        fetch(`/reaccionar/${postId}`, { method: 'POST', headers: {'X-Requested-With':'XMLHttpRequest','Content-Type':'application/json'} })
        .then(res => res.json())
        .then(data => {
            if(data.status==='success'){
                countSpan.textContent = data.total;
                btn.style.color = data.accion==='added' ? '#ff4d4d' : '#fff';
            }
        }).catch(console.error);
    }
});

// ------------------- Likes de comentarios -------------------
document.addEventListener('click', function(e){
    if(e.target.classList.contains('btn-like-mini')){
        e.preventDefault();
        const form = e.target.closest('form');
        const span = form.closest('.comentario-item').querySelector('.comentario-likes-count');
        const actionUrl = form.action;

        fetch(actionUrl,{ method:'POST', headers:{'X-Requested-With':'XMLHttpRequest'} })
        .then(res=>res.json())
        .then(data=>{
            if(data.status==='success'){
                span.textContent = data.total;
                e.target.textContent = data.accion==='added' ? '‚ù§Ô∏è' : 'ü§ç';
            }
        }).catch(console.error);
    }
});

// ------------------- Comentarios AJAX -------------------
document.addEventListener('submit', function(e){
    const form = e.target.closest('.form-comentario');
    if(!form) return;
    e.preventDefault();

    const postId = form.dataset.postId;
    const input = form.querySelector('input[name="texto"]');
    const btn = form.querySelector('button[type="submit"]');
    const texto = input.value.trim();
    if(!texto) return;

    input.disabled = true;
    btn.disabled = true;

    fetch(`/comentar/${postId}`,{
        method:'POST',
        headers:{'X-Requested-With':'XMLHttpRequest','Content-Type':'application/x-www-form-urlencoded'},
        body: new URLSearchParams({ texto })
    })
    .then(res=>res.json())
    .then(data=>{
        if(data.status!=='success') throw new Error('Error backend');
        const post = form.closest('.post');
        const lista = post.querySelector('.lista-comentarios');
        lista.insertAdjacentHTML('afterbegin',data.html);
        input.value=''; input.disabled=false; btn.disabled=false;
    })
    .catch(err=>{console.error(err); input.disabled=false; btn.disabled=false;});
});

document.addEventListener('click', function(e){
    if(e.target.classList.contains('btn-borrar-comentario')){
        e.preventDefault();
        const comentarioId = e.target.dataset.id;
        const comentarioDiv = document.getElementById(`comentario-${comentarioId}`);

        if(!confirm("¬øSeguro que quieres borrar este comentario?")) return;

        fetch(`/borrar_comentario/${comentarioId}`, {
            method: 'POST',
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(res => res.json())
        .then(data => {
            if(data.status === 'success'){
                // eliminar el div del comentario del DOM
                comentarioDiv.remove();
            } else {
                alert(data.message || "No se pudo borrar el comentario");
            }
        })
        .catch(err => console.error("Error al borrar comentario:", err));
    }
});

</script>

</body>
</html>